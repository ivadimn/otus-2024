#include "common.h"
#include "tables.h"
#include <fcntl.h>


uint16_t cp1251[128] = {
//   0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  32   33   34   35   36   37   38   39   40 Ё    41   42   43   44   45   46   47
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xd081, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  48   49   50   51   52   53   54   55   56 ё    57   58   59   60   61   62   63
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xd191, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
//  64 А    65 Б    66 В    67 Г    68 Д    69 Е    70 Ж    71 З      
    0x90d0, 0x91d0, 0x92d0, 0x93d0, 0x94d0, 0x95d0, 0x96d0, 0x97d0, 
//  72 И    73 Й    74 К    75 Л    76 М    77 Н    78 О    79 П
    0x98d0, 0x99d0, 0x9ad0, 0x9bd0, 0x9cd0, 0x9dd0, 0x9ed0, 0x9fd0, 
//  80 Р    81 С    82 Т    83 У    84 Ф    85 Х    86 Ц    87 Ч  
    0xa0d0, 0xa1d0, 0xa2d0, 0xa3d0, 0xa4d0, 0xa5d0, 0xa6d0, 0xa7d0, 
//  88 Ш    89 Щ    90 Ъ    91 Ы    92 Ь    93 Э    94 Ю    95 Я  
    0xa8d0, 0xa9d0, 0xaad0, 0xabd0, 0xacd0, 0xadd0, 0xaed0, 0xafd0, 
//  96 а    97 б    98 в    99 г    100 д   101 е   102 ж   103 з 
    0xb0d0, 0xb1d0, 0xb2d0, 0xb3d0, 0xb4d0, 0xb5d0, 0xb6d0, 0xb7d0, 
//  104 и   105 й   106 к   107 л   108 м   109 н   110 о   111 п   
    0xb8d0, 0xb9d0, 0xbad0, 0xbbd0, 0xbcd0, 0xbdd0, 0xbed0, 0xbfd0, 
//  112 р   113 с   114 т   115 у   116 ф   117 х   118 ц   119 ч
    0x80d1, 0x81d1, 0x82d1, 0x83d1, 0x84d1, 0x85d1, 0x86d1, 0x87d1, 
//  120 ш   121 щ   122 ъ   123 ы   124 ь   125 э   126 ю   127 я        
    0x88d1, 0x89d1, 0x8ad1, 0x8bd1, 0x8cd1, 0x8dd1, 0x8ed1, 0x8fd1
};

uint16_t koi_8r[128] = {
//   0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  16   17     18   19   20   21   22   23   24   25   26   27   28   29   30   31
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  32   33   34   35 ё    36   37   38   39   40    41   42   43   44   45   46   47
    0x0, 0x0, 0x0, 0xd191, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  48   49   50   51 Ё    52   53   54   55   56   57   58   59   60   61   62   63
    0x0, 0x0, 0x0, 0xd081, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
//  64 ю    65 а    66 б    67 ц    68 д    69 е    70 ф    71 г
    0x8ed1, 0xb0d0, 0xb1d0, 0x86d1, 0xb4d0, 0xb5d0, 0x84d1, 0xb3d0, 
//  72 х    73 и    74 й    75 к    76 л    77 м    78 н    79 о
    0x85d1, 0xb8d0, 0xb9d0, 0xbad0, 0xbbd0, 0xbcd0, 0xbdd0, 0xbed0, 
//  80 п    81 я    82 р    83 с    84 т    85 у    86 ж    87 в  
    0xbfd0, 0x8fd1, 0x80d1, 0x81d1, 0x82d1, 0x83d1, 0xb6d0, 0xb2d0, 
//  88 ь    89 ы    90 з    91 ш    92 э    93 щ    94 ч    95 ъ 
    0x8cd1, 0x8bd1, 0xb7d0, 0x88d1, 0x8dd1, 0x89d1, 0x87d1, 0x8ad1, 
//  96 Ю    97 А    98 Б    99 Ц    100 Д   101 Е   102 Ф   103 Г
    0xaed0, 0x90d0, 0x91d0, 0xa6d0, 0x94d0, 0x95d0, 0xa4d0, 0x93d0, 
//  104 Х   105 И   106 Й   107 К   108 Л   109 М   110 Н   111 О  
    0xa5d0, 0x98d0, 0x99d0, 0x9ad0, 0x9bd0, 0x9cd0, 0x9dd0, 0x9ed0, 
//  112 П   113 Я   114 Р   115 С   116 Т   117 У   118 Ж   119 В
    0x9fd0, 0xafd0, 0xa0d0, 0xa1d0, 0xa2d0, 0xa3d0, 0x96d0, 0x92d0, 
//  120 Ь   121 Ы   122 З   123 Ш   124 Э   125 Щ   126 Ч   127 Ъ       
    0xacd0, 0xabd0, 0x97d0, 0xa8d0, 0xadd0, 0xa9d0, 0xa7d0, 0xaad0
};

uint16_t iso[128] = {
//   0    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  32   33 Ё    34   35   36   37   38   39   40   41   42   43   44   45   46   47
    0x0, 0xd081, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  48 А    49 Б    50 В    51 Г    52 Д    53 Е    54 Ж    55 З      
    0x90d0, 0x91d0, 0x92d0, 0x93d0, 0x94d0, 0x95d0, 0x96d0, 0x97d0,
//  56 И    57 Й    58 К    59 Л    60 М    61 Н    62 О    63 П
    0x98d0, 0x99d0, 0x9ad0, 0x9bd0, 0x9cd0, 0x9dd0, 0x9ed0, 0x9fd0, 
//  64 Р    65 С    66 Т    67 У    68 Ф    69 Х    70 Ц    71 Ч  
    0xa0d0, 0xa1d0, 0xa2d0, 0xa3d0, 0xa4d0, 0xa5d0, 0xa6d0, 0xa7d0, 
//  72 Ш    73 Щ    74 Ъ    75 Ы    76 Ь    77 Э    78 Ю    79 Я  
    0xa8d0, 0xa9d0, 0xaad0, 0xabd0, 0xacd0, 0xadd0, 0xaed0, 0xafd0, 
//  80 а    81 б    82 в    83 г    84 д    85 е    86 ж    87 з 
    0xb0d0, 0xb1d0, 0xb2d0, 0xb3d0, 0xb4d0, 0xb5d0, 0xb6d0, 0xb7d0, 
//  88 и    89 й    90 к    91 л    92 м    93 н    94 о    95 п   
    0xb8d0, 0xb9d0, 0xbad0, 0xbbd0, 0xbcd0, 0xbdd0, 0xbed0, 0xbfd0, 
//  96 р    97 с    98 т    99 у    100 ф   101 х   102 ц   103 ч
    0x80d1, 0x81d1, 0x82d1, 0x83d1, 0x84d1, 0x85d1, 0x86d1, 0x87d1, 
//  104 ш   105 щ   106 ъ   107 ы   108 ь   109 э   110 ю   111 я        
    0x88d1, 0x89d1, 0x8ad1, 0x8bd1, 0x8cd1, 0x8dd1, 0x8ed1, 0x8fd1,
//  112  113 ё   114  115  116  117  118  119        
    0x0, 0xd191, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
//  120  121  122  123  124  125  126  127        
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0    
};

void to_utf8(char* infile, char* outfile, encode_t encode) {
    
    int fd_in, fd_out;
    uint8_t code;
    long fsize;
    uint8_t *buffer;
    ssize_t reading_size;
    uint16_t *table;

    switch (encode)
    {
        case CP_1251:
            table = cp1251;
            break;
        case KOI_8R:
            table = koi_8r;
            break;
        case ISO_8859_5:
            table = iso;
            break;    
        default:
            break;
    }    

    fd_in = open(infile, O_RDONLY);
    if (fd_in == -1)
        err_sys("Ошибка открытия файла: %s", infile);

    fsize = getFileSize(fd_in);
    if (fsize == -1) {
        err_sys("Ошибка при определении размера файла: %s", infile);
    }

    fd_out = open(outfile, O_CREAT | O_RDWR,  FILE_MODE) ;
    
    if (fd_out == -1)
        err_sys("Ошибка создания файла: %s", infile);

    if (fsize < BUF_SIZE) {
        reading_size = fsize * sizeof(uint8_t);
        buffer = (uint8_t*) malloc(reading_size);
    }
    else {
        reading_size = BUF_SIZE * sizeof(uint8_t);
        buffer = (uint8_t*) malloc(reading_size);
    }

    if (buffer == NULL)
        err_sys("Ошибка распределения памяти.");
        
    while ((reading_size = read(fd_in, buffer, reading_size)) > 0) {
        for (int i = 0; i < reading_size; i++) {
            code = buffer[i]; 
            if(code < 128)
                write(fd_out, &code, sizeof(uint8_t));
            else 
                write(fd_out, &table[code - SIZE_OFF], sizeof(uint16_t));
        }
    }
    printf("Файл %s записан успешно.\n", outfile);
    free(buffer);
    close(fd_in);
    close(fd_out);
    return;
}

void print_usage() {
    printf("\nПрограмма encode конвертирует текстовые файлы в кодировку UTF-8.\n");
    printf("Использование encode имя_входного_файла кодировка имя_выходного_файла.\n");
    printf("Возможные кодировки:\n");
    printf("\tcp1251\n");
    printf("\tkoi-8r\n");
    printf("\tiso-8859-5\n\n");
}